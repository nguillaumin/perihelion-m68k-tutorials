<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="perihelion of poSTmortem">
<title>The Atari ST MC68000 Assembly Language Tutorials</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
<a href="https://github.com/nguillaumin/perihelion-m68k-tutorials"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>
<style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
</head>
<body id="_of_controlling_the_puppets" class="book toc2 toc-left">
<div id="header">
<h1>The Atari ST MC68000 Assembly Language Tutorials</h1>
<div class="details">
<span id="author" class="author">perihelion of poSTmortem</span><br>
<span id="revnumber">version 1st edition (v0.84),</span>
<span id="revdate">August 28th 2004 | edited by bp</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<p><span class="toc-root"><a href="index.html">The Atari ST MC68000 Assembly Language Tutorials</a></span></p><ul class="sectlevel1">
<li><a href="_foreword.html">Foreword</a>
</li>
<li><a href="_on_the_theory_behind_programming.html">On The Theory Behind Programming</a>
</li>
<li><a href="_of_the_workings_of_devpac_3_and_the_realisation_of_some_code.html">Of The Workings Of Devpac 3 And The Realisation Of Some Code</a>
</li>
<li><a href="_of_various_things_mystic_and_important_mainly_concerning_the_art_of_understanding_digits_and_performing_traps.html">Of Various Things Mystic And Important, Mainly Concerning The Art Of Understanding Digits And Performing Traps</a>
</li>
<li><a href="_of_the_ways_of_addressing_memory.html">Of The Ways Of Addressing Memory</a>
</li>
<li><a href="_of_the_workings_of_the_graphics_memory_and_minor_skills_in_branching.html">Of The Workings Of The Graphics Memory And Minor Skills In Branching</a>
</li>
<li><a href="_of_seeing_behind_the_curtain_of_an_execution_and_getting_intimate_with_files.html">Of Seeing Behind The Curtain Of An Execution And Getting Intimate With Files</a>
</li>
<li><a href="_on_scrollers.html">On Scrollers</a>
</li>
<li><a href="_of_scrolling_8_pixels_per_vbl_using_double_buffer.html">Of Scrolling 8 Pixels Per VBL Using Double Buffer</a>
</li>
<li><a href="_of_revealing_the_unseen_and_expanding_our_consciousness_without_the_use_of_illegal_drugs.html">Of Revealing The Unseen And Expanding Our Consciousness Without The Use Of Illegal Drugs</a>
</li>
<li><a href="_of_lighting_a_candle_and_casting_a_shadow.html">Of Lighting A Candle (And Casting A Shadow)</a>
</li>
<li><a href="_of_making_the_mountain_move_to_mohammed.html">Of Making The Mountain Move To Mohammed</a>
</li>
<li><a href="_of_controlling_the_puppets.html"><span class="toc-current">Of Controlling The Puppets</span></a>
</li>
<li><a href="_of_hearing_that_which_is_spoken.html">Of Hearing That Which Is Spoken</a>
</li>
<li><a href="_of_using_the_gramophone.html">Of Using The Gramophone</a>
</li>
<li><a href="_on_fading_to_black.html">On Fading To Black</a>
</li>
<li><a href="_appendixes.html">Appendixes</a>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_of_controlling_the_puppets">Of Controlling The Puppets</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>2002-07-13 (last edition of the initial revision)</em></p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>I love the smell of napalm in the morning&#8230;&#8203; it smells like victory</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Apocalypse Now
</div>
</div>
<div class="paragraph">
<p>Yep, here we go again, this time I think we&#8217;ll have a nice little tutorial on our hands, not that
big. It only concerns the workings of the joystick. It could&#8217;ve involved the mouse as well, but
to be honest I haven&#8217;t gotten the workings of the mouse down yet. The code will build
heavily on the previous tutorial, since we are going to move a sprite around with the joystick,
but you don&#8217;t need to understand the sprite parts of the code to understand the workings of
the joystick. If you don&#8217;t know what a joystick is, or if you don&#8217;t recognise the little sprite ship
used in the sample source, you are not allowed to read further. Please stop this instant and
browse the web for more generally related Atari information.</p>
</div>
<div class="paragraph">
<p>A while back, I thought the ST was so much cooler than your average PC, because with the
ST, you just have to plug in a joystick and it works. With a PC, you have to install drivers and
shit, and configure the exact joystick and generally mess around lots and perhaps even then
it won&#8217;t work or the program you want to run doesn&#8217;t support your joystick. All in all inferior
construction, or so I thought. Actually, with the ST, you also need to set up your own joystick
driver. In fact, since you usually don&#8217;t have a hard drive and the OS (operating system)
doesn&#8217;t have drivers for the joystick, every program needs it&#8217;s own drivers for the joystick.
Writing the joystick driver isn&#8217;t at all difficult, but you have to have some working knowledge
to do it.</p>
</div>
<div class="paragraph">
<p>There is a little 6301 processor inside the Atari ST, which takes care of the keyboard, the
mouse and the joystick. It even has a real time clock. This cute little chip is sometimes
referred to as the IKBD, for <strong>I</strong>ntelligent <strong>K</strong>ey<strong>B</strong>oar<strong>D</strong>. It might be fun to know that the IKBD has
4K (4096 bytes) of ROM memory, and 128 bytes of RAM. ROM stands for <strong>R</strong>ead <strong>O</strong>nly <strong>M</strong>emory,
and as it says, it&#8217;s memory that can&#8217;t be altered, RAM is <strong>R</strong>andom <strong>A</strong>ccess <strong>M</strong>emory and it is that
which we usually mean by memory. The 128 bytes of RAM on the IKBD are only used as a
temporal storage area. The reason for having a separate chip altogether taking care of the
keyboard, mouse and joystick is that those actions won&#8217;t burden the main processor (the
68000, the one we&#8217;ve been programming so far in these tutorials). Instead, we can poll the
IKBD as we choose, or tell it to report stuff in any way we choose, and just let the IKBD
worry about the details.</p>
</div>
<div class="paragraph">
<p>Our mission therefore is clear: we must find a way to make the IKBD report the status of the
joystick, and also find a way to read that status in some way. When that is accomplished, we
can use the sprite routine from the previous tutorial as it is, with only a change in the
<code>move_sprite</code> subroutine. The new subroutine will update the X and Y coordinates in
accordance with the joystick status instead of just moving it about.</p>
</div>
<div class="paragraph">
<p>Trap function 25 of the XBIOS will allow us to send commands to the IKBD. However, unlike
other trap calls, the input data is a pointer to a string of data. <a href="appendixes/ikbd.txt">IKBD Protocol</a> may
seem very sketchy and difficult to understand, but it does contain a list of all the possible
commands that you can send to the IKBD, taking a look inside it, we see function <code>$14</code>. IKBD
command <code>$14</code> will report joystick status every time the joystick is changed. All well and good,
this is how we set it up.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="m68k">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">joy_on</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>           <span class="c1">; pointer to IKBD instructions</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>                <span class="c1">; instruction length - 1</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>               <span class="c1">; send instruction to IKBD</span>
                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">14</span>
                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">a7</span>

<span class="nl">joy_on</span>          <span class="kt">dc</span><span class="nd">.b </span>   <span class="mh">$14</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first parameter is a pointer to the address which contains the commands, the second
parameter is the length in bytes of the command list minus one, in this case zero. Then the
function number, a trap calling XBIOS and a normal stack clean up. Sure, so now the joystick
reports information, but where does the information go? Well, actually we need to write our
own routine to read the joystick information.</p>
</div>
<div class="paragraph">
<p>Every time the joystick sends information, there is a jump to an address with instructions of
what to do with this data, compare this with the timers from <a href="#">tutorial 9</a>.
Also, as with the timers, we will hook up our own routine to read the joystick. With trap
function 34 of the XBIOS, the IKBD returns a list of all its vectors. The address of the IKBD
vectors is put in <code>d0</code>. The joystick report vector is at offset 24, so by putting our own
joystick routine at the address pointed to by <code>d0</code>+24, we have effectively hooked up our
own joystick routine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="m68k">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">34</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>
                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">14</span>
                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">a7</span>                   <span class="c1">; return IKBD vector table</span>

                <span class="k">move</span><span class="nd">.l </span><span class="nb">d0</span><span class="p">,</span> <span class="nv">ikbd_vec</span>              <span class="c1">; store IKBD vectors address</span>
                <span class="k">move</span><span class="nd">.l </span><span class="nb">d0</span><span class="p">,</span> <span class="nb">a0</span>                    <span class="c1">; a0 points to IKBD vectors</span>
                <span class="k">move</span><span class="nd">.l </span><span class="mi">24</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nv">old_joy</span>           <span class="c1">; backup old joystick vector</span>
                <span class="k">move</span><span class="nd">.l #</span><span class="nv">read_joy</span><span class="p">,</span> <span class="mi">24</span><span class="p">(</span><span class="nb">a0</span><span class="p">)</span>         <span class="c1">; input our joystick vector</span>

<span class="nl">read_joy</span>
                <span class="k">nop</span>                              <span class="c1">; so far, we don't know what to do</span>
                <span class="k">rts</span>                              <span class="c1">; note, rts, not rte</span>

<span class="nl">dc</span><span class="nd">.l </span>           <span class="nv">ikbd_vec</span>                         <span class="c1">; old IKBD vector storage</span>
<span class="nl">dc</span><span class="nd">.l </span>           <span class="nv">old_joy</span>                          <span class="c1">; old joy vector storage</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Straightforward, first get the address of the IKBD vectors. Store it for future restoration. Then
put the address in a0 so that a0 points to the IKBD vectors, backup the old joystick vector
which is found at offset 24, and input our own joystick routine. By the way, the mouse vector
is at offset 16. With the help of this and the information given on the other IKBD commands
on appendices/ikbd.txt[IKBD Protocol], you should be able to setup your own mouse routine as well.</p>
</div>
<div class="paragraph">
<p>The joystick routine ends with an rts, nothing else, and may not take more than 1/100 of a
second (half a VBL, more than enough time really). What happens now is that each time the
joystick status is changed, the ST will jump to our joystick routine. Once there, <code>a0</code> will point
to three bytes in memory which contain the status of the joysticks.</p>
</div>
<div class="paragraph">
<p>The first of these bytes is a header telling us which joystick it was that did something. The
byte will contain <code>$FE</code> if joystick 0 did something, and <code>$FF</code> if it was joystick 1 (meaning the last
bit represents either joystick 0 or joystick 1). Remember, joystick 0 is the joystick port shared
with the mouse, and joystick 1 is the port exclusively for joysticks. The next two bytes
contain the actual information for the joysticks. The first one holds status for joystick 0, and
the other one for joystick 1. The data has this structure</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">F</th>
<th class="tableblock halign-center valign-top">0</th>
<th class="tableblock halign-center valign-top">0</th>
<th class="tableblock halign-center valign-top">0</th>
<th class="tableblock halign-center valign-top">R</th>
<th class="tableblock halign-center valign-top">L</th>
<th class="tableblock halign-center valign-top">D</th>
<th class="tableblock halign-center valign-top">U</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" colspan="8"><p class="tableblock">(F = fire, R = right, L = left, D = down, U = up)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>So if bit 7 is set, the fire button was pressed, if bit 0 is set, the joystick is moved up, if bit 0,
2 and 7 are set, the joystick is moved up-right while the fire button is being pressed. Real
simple. Here&#8217;s a joystick routine that will simply store the joystick data in memory, two
different variables could have been used instead of course (but this is good practice on
addressing modes).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="m68k"><span class="nl">read_joy</span>
<span class="c1">; executes every time joystick information is changed</span>
                <span class="k">move</span><span class="nd">.b </span> <span class="mi">1</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nv">joy</span>               <span class="c1">; store joy 0 data</span>
                <span class="k">move</span><span class="nd">.b </span> <span class="mi">2</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nv">joy</span><span class="o">+</span><span class="mi">1</span>             <span class="c1">; store joy 1 data</span>
                <span class="k">rts</span>

<span class="nl">joy</span>             <span class="kt">ds</span><span class="nd">.b </span><span class="mi">2</span>                           <span class="c1">; storage for joystick data</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it! Well, almost. We must restore our poor system, for one thing, it would be good to
turn the mouse back on :) When we turn on the joystick, the mouse is turned off. In order to
turn it on, we send command <code>$08</code> to the IKBD, to put the mouse in relative report mode,
which would probably be the default mode for the mouse then. While we&#8217;re at it, might be
good to restore the joystick vector as well. For the curious lot out there, "mus" is Swedish for
mouse, and it&#8217;s a suitable short form for mouse as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="m68k">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">mus_on</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>           <span class="c1">; pointer to IKBD instruction</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>                <span class="c1">; length of instruction - 1</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>               <span class="c1">; send instruction to IKBD</span>
                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">14</span>
                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">a7</span>

                <span class="k">move</span><span class="nd">.l </span> <span class="nv">ikbd_vec</span><span class="p">,</span> <span class="nb">a0</span>             <span class="c1">; a0 points to old IKBD vectors</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nv">old_joy</span><span class="p">,</span> <span class="mi">24</span><span class="p">(</span><span class="nb">a0</span><span class="p">)</span>          <span class="c1">; restore joystick vector</span>

<span class="nl">mus_on</span>          <span class="kt">dc</span><span class="nd">.b </span>   <span class="mh">$08</span>
<span class="nl">ikbd_vec</span>        <span class="kt">ds</span><span class="nd">.l </span>   <span class="mi">1</span> <span class="nv">IKBD</span> <span class="nv">vector</span> <span class="nv">storage</span>
<span class="nl">old_joy</span>         <span class="kt">ds</span><span class="nd">.l </span>   <span class="mi">1</span> <span class="nv">old</span> <span class="nv">joy</span> <span class="nv">vector</span> <span class="nv">storage</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Two other commands of the IKBD that might be good to know about are <code>$1A</code>, which turns off
the joystick, and <code>$12</code> which turns off the mouse. Let&#8217;s say we want to be on the really safe
side and not only turn on joystick reporting but also turn off mouse reporting, it would look
thusly</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="m68k">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">joy_on</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>           <span class="c1">; pointer to IKBD instructions</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>                <span class="c1">; instruction length - 1</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>               <span class="c1">; send instruction to IKBD</span>
                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">14</span>
                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">a7</span>

<span class="nl">joy_on</span>          <span class="kt">dc</span><span class="nd">.b </span>   <span class="mh">$14</span><span class="p">,</span> <span class="mh">$12</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how the extra parameters are just appended to the command list, and the update of the
instruction length parameter to reflect the new command list length. Here comes the source
of the program, hold on!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="m68k">                <span class="k">jsr</span>     <span class="nv">initialise</span>
                
<span class="c1">; pre-shifting sprite</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">spr_dat</span><span class="p">,</span> <span class="nb">a0</span>              <span class="c1">; original sprite data</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">34</span><span class="p">,</span> <span class="nb">a0</span>                   <span class="c1">; skip palette</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">sprite</span><span class="p">,</span> <span class="nb">a1</span>               <span class="c1">; storage of pre-shifted sprite</span>
                
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                 <span class="c1">; 32 scan lines per sprite</span>
<span class="nl">first_sprite</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>              <span class="c1">; move from original to pre-shifted</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>              <span class="c1">; 32 pixels moved</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">a1</span>                    <span class="c1">; jump over end words</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">144</span><span class="p">,</span> <span class="nb">a0</span>                  <span class="c1">; jump to next scan line</span>
                <span class="k">dbf</span>     <span class="nb">d0</span><span class="p">,</span> <span class="nv">first_sprite</span>
<span class="c1">; the picture sprite has been copied to first position in pre-shift </span>

                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">sprite</span><span class="p">,</span> <span class="nb">a0</span>               <span class="c1">; point to beginning of storage area</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">sprite</span><span class="p">,</span> <span class="nb">a1</span>               <span class="c1">; point to beginning of storage area</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">768</span><span class="p">,</span> <span class="nb">a1</span>                  <span class="c1">; point to next sprite position</span>
                
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">15</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d1</span>                 <span class="c1">; 15 sprite positions left</span>
<span class="nl">positions</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d2</span>                 <span class="c1">; 32 scan lines per sprite</span>
<span class="nl">line</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">4</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d3</span>                  <span class="c1">; 4 bit planes</span>
<span class="nl">plane</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nb">d0</span>                  <span class="c1">; move one word </span>
                <span class="k">roxr</span>    <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; pre-shift</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nb">d0</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span>                  <span class="c1">; put it in place     </span>
                
                <span class="k">move</span><span class="nd">.w </span> <span class="mi">8</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nb">d0</span>                 <span class="c1">; move one word</span>
                <span class="k">roxr</span>    <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; pre-shift</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nb">d0</span><span class="p">,</span> <span class="mi">8</span><span class="p">(</span><span class="nb">a1</span><span class="p">)</span>                 <span class="c1">; put it in place</span>
                
                <span class="k">move</span><span class="nd">.w </span> <span class="mi">16</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nb">d0</span>                <span class="c1">; move one word</span>
                <span class="k">roxr</span>    <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; pre-shift</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nb">d0</span><span class="p">,</span> <span class="mi">16</span><span class="p">(</span><span class="nb">a1</span><span class="p">)</span>                <span class="c1">; put it in place</span>

                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">a0</span>                    <span class="c1">; next bit plane, also clears X flag</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">a1</span>                    <span class="c1">; next bit plane</span>

                <span class="k">dbf</span>     <span class="nb">d3</span><span class="p">,</span> <span class="nv">plane</span>   

                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">16</span><span class="p">,</span> <span class="nb">a1</span>                   <span class="c1">; next scan line</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">16</span><span class="p">,</span> <span class="nb">a0</span>                   <span class="c1">; next scan line</span>

                <span class="k">dbf</span>     <span class="nb">d2</span><span class="p">,</span> <span class="nv">line</span>    

                <span class="k">dbf</span>     <span class="nb">d1</span><span class="p">,</span> <span class="nv">positions</span>
<span class="c1">; pre-shift of sprite done, all 16 sprite positions saved in sprite</span>

                
<span class="c1">; pre-shifting mask</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">spr_dat</span><span class="p">,</span> <span class="nb">a0</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">34</span><span class="o">+</span><span class="mi">160</span><span class="o">*</span><span class="mi">32</span><span class="p">,</span> <span class="nb">a0</span>            <span class="c1">; skip palette and sprite</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">mask</span><span class="p">,</span> <span class="nb">a1</span>                 <span class="c1">; load up mask part</span>
                
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                 <span class="c1">; 32 scan lines per sprite</span>
<span class="nl">first_mask</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span>               <span class="c1">; move from original to pre-shifted</span>
                <span class="k">not</span><span class="nd">.l </span>  <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>                     <span class="c1">; invert the mask data</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span>
                <span class="k">not</span><span class="nd">.l </span>  <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>                     <span class="c1">; invert the mask data</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span>
                <span class="k">not</span><span class="nd">.l </span>  <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>                     <span class="c1">; invert the mask data</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span>     
                <span class="k">not</span><span class="nd">.l </span>  <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>                     <span class="c1">; invert the mask data</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mh">$ffffffff</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>         <span class="c1">; fill last two words...</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mh">$ffffffff</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>         <span class="c1">; ... with all 1's</span>
                
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">144</span><span class="p">,</span> <span class="nb">a0</span>                  <span class="c1">; jump to next scan line</span>
                <span class="k">dbf</span>     <span class="nb">d0</span><span class="p">,</span> <span class="nv">first_mask</span>
<span class="c1">; the picture mask has been copied to first position in pre-shift   </span>

                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">mask</span><span class="p">,</span> <span class="nb">a0</span>                 <span class="c1">; point to beginning of storage area</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">mask</span><span class="p">,</span> <span class="nb">a1</span>                 <span class="c1">; point to beginning of storage area</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">768</span><span class="p">,</span> <span class="nb">a1</span>                  <span class="c1">; point to next mask position</span>
                
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">15</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d1</span>                 <span class="c1">; 15 sprite positions left</span>
<span class="nl">positions_mask</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d2</span>                 <span class="c1">; 32 scan lines per sprite</span>
<span class="nl">line_mask</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">4</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d3</span>                  <span class="c1">; 4 bit planes</span>
<span class="nl">plane_mask</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nb">d0</span>                  <span class="c1">; move one word </span>
                <span class="k">roxr</span>    <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; pre-shift</span>
                <span class="k">or</span><span class="nd">.w </span>   <span class="nd">#</span><span class="mb">%1000000000000000</span><span class="p">,</span> <span class="nb">d0</span>    <span class="c1">; make sure most significant bit set</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nb">d0</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span>                  <span class="c1">; put it in place     </span>
                
                <span class="k">move</span><span class="nd">.w </span> <span class="mi">8</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nb">d0</span>                 <span class="c1">; move one word</span>
                <span class="k">roxr</span>    <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; pre-shift</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nb">d0</span><span class="p">,</span> <span class="mi">8</span><span class="p">(</span><span class="nb">a1</span><span class="p">)</span>                 <span class="c1">; put it in place</span>
                
                <span class="k">move</span><span class="nd">.w </span> <span class="mi">16</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nb">d0</span>                <span class="c1">; move one word</span>
                <span class="k">roxr</span>    <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; pre-shift</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nb">d0</span><span class="p">,</span> <span class="mi">16</span><span class="p">(</span><span class="nb">a1</span><span class="p">)</span>                <span class="c1">; put it in place</span>

                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">a1</span>                    <span class="c1">; next bit plane</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">a0</span>                    <span class="c1">; next plane, clears X flag (bad)</span>

                <span class="k">dbf</span>     <span class="nb">d3</span><span class="p">,</span> <span class="nv">plane_mask</span>

                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">16</span><span class="p">,</span> <span class="nb">a1</span>                   <span class="c1">; next scan line</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">16</span><span class="p">,</span> <span class="nb">a0</span>                   <span class="c1">; next scan line</span>

                <span class="k">dbf</span>     <span class="nb">d2</span><span class="p">,</span> <span class="nv">line_mask</span>

                <span class="k">dbf</span>     <span class="nb">d1</span><span class="p">,</span> <span class="nv">positions_mask</span>
<span class="c1">; pre-shift of mask done, all 16 sprite positions saved in mask</span>

                
                <span class="k">movem</span><span class="nd">.l </span><span class="nv">bg</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="nb">d0</span><span class="o">-</span><span class="nb">d7</span>
                <span class="k">movem</span><span class="nd">.l </span><span class="nb">d0</span><span class="o">-</span><span class="nb">d7</span><span class="p">,</span> <span class="mh">$ff8240</span>
                
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">bg</span><span class="o">+</span><span class="mi">34</span><span class="p">,</span> <span class="nb">a0</span>                <span class="c1">; pixel part of background</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="mh">$44e</span><span class="p">,</span> <span class="nb">a1</span>                  <span class="c1">; put screen memory in a1</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">7999</span><span class="p">,</span> <span class="nb">d0</span>                 <span class="c1">; 8000 longwords to a screen</span>
<span class="nl">pic_loop</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>              <span class="c1">; move one longword to screen</span>
                <span class="k">dbf</span>     <span class="nb">d0</span><span class="p">,</span> <span class="nv">pic_loop</span>              <span class="c1">; background painted</span>

                <span class="k">jsr</span>     <span class="nv">save_background</span>           <span class="c1">; something in restore buffer</span>


<span class="c1">; joy code</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">34</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>
                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">14</span>
                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">a7</span>                    <span class="c1">; return IKBD vector table</span>

                <span class="k">move</span><span class="nd">.l </span> <span class="nb">d0</span><span class="p">,</span> <span class="nv">ikbd_vec</span>              <span class="c1">; store IKBD vectors address</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nb">d0</span><span class="p">,</span> <span class="nb">a0</span>                    <span class="c1">; a0 points to IKBD vectors</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="mi">24</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nv">old_joy</span>           <span class="c1">; backup old joystick vector      </span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">read_joy</span><span class="p">,</span> <span class="mi">24</span><span class="p">(</span><span class="nb">a0</span><span class="p">)</span>         <span class="c1">; input my joystick vector</span>

                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">joy_on</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>            <span class="c1">; pointer to IKBD instructions</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>                 <span class="c1">; instruction length - 1</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>                <span class="c1">; send instruction to IKBD</span>
                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">14</span>
                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">a7</span>
<span class="c1">; end joystick init</span>
                
                <span class="k">move</span><span class="nd">.l </span> <span class="mh">$70</span><span class="p">,</span> <span class="nv">old_70</span>               <span class="c1">; backup $70</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="kr">main</span><span class="p">,</span> <span class="mh">$70</span>                <span class="c1">; put in main routine</span>
                
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>
                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">1</span>
                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">a7</span>                    <span class="c1">; wait keypress</span>

                <span class="k">move</span><span class="nd">.l </span> <span class="nv">old_70</span><span class="p">,</span> <span class="mh">$70</span>               <span class="c1">; restore old $70</span>
                    
<span class="c1">; joy code</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">mus_on</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>            <span class="c1">; pointer to IKBD instruction</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>                 <span class="c1">; length of instruction - 1</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>                <span class="c1">; send instruction to IKBD</span>
                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">14</span>
                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">a7</span>

                <span class="k">move</span><span class="nd">.l </span> <span class="nv">ikbd_vec</span><span class="p">,</span> <span class="nb">a0</span>              <span class="c1">; a0 points to old IKBD vectors</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nv">old_joy</span><span class="p">,</span> <span class="mi">24</span><span class="p">(</span><span class="nb">a0</span><span class="p">)</span>           <span class="c1">; restore joystick vector</span>
<span class="c1">; end shut down    </span>
                    
                    
                <span class="k">jsr</span>     <span class="nv">restore</span>
                    
                <span class="k">clr</span><span class="nd">.l </span>  <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>
                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">1</span>                        <span class="c1">; exit</span>

<span class="nl">main</span>
                <span class="k">movem</span><span class="nd">.l </span><span class="nb">d0</span><span class="o">-</span><span class="nb">d7</span><span class="o">/</span><span class="nb">a0</span><span class="o">-</span><span class="nb">a6</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>        <span class="c1">; backup registers</span>
                
                <span class="k">jsr</span>     <span class="nv">restore_background</span>
                <span class="k">jsr</span>     <span class="nv">move_sprite</span>
                <span class="k">jsr</span>     <span class="nv">save_background</span>
                <span class="k">jsr</span>     <span class="nv">apply_mask</span>
                <span class="k">jsr</span>     <span class="nv">put_sprite</span>

                <span class="k">movem</span><span class="nd">.l </span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="nb">d0</span><span class="o">-</span><span class="nb">d7</span><span class="o">/</span><span class="nb">a0</span><span class="o">-</span><span class="nb">a6</span>        <span class="c1">; restore registers</span>

                <span class="nv">rte</span>

<span class="nl">move_sprite</span>
<span class="c1">; updates x and y coordinates according to joystick 1</span>
<span class="c1">; if fire button pressed, add 1 to colour 0</span>
                <span class="k">move</span><span class="nd">.b </span> <span class="nv">joy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                 <span class="c1">; check joystick 1</span>

                <span class="k">cmp</span>     <span class="nd">#</span><span class="mi">128</span><span class="p">,</span> <span class="nb">d0</span>                  <span class="c1">; fire</span>
                <span class="k">blt</span>     <span class="nv">no_fire</span>
                <span class="k">add</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mh">$001</span><span class="p">,</span> <span class="mh">$ff8240</span>
                <span class="k">and</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mb">%01111111</span><span class="p">,</span> <span class="nb">d0</span>            <span class="c1">; clear fire bit      </span>
<span class="nl">no_fire</span>

                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; up</span>
                <span class="k">beq</span>     <span class="nv">up</span>
                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; down</span>
                <span class="k">beq</span>     <span class="nv">down</span>
                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">4</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; left</span>
                <span class="k">beq</span>     <span class="nv">left</span>        
                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; right</span>
                <span class="k">beq</span>     <span class="nv">right</span>
                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">9</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; up-right</span>
                <span class="k">beq</span>     <span class="nv">up_right</span>
                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">10</span><span class="p">,</span> <span class="nb">d0</span>                   <span class="c1">; down-right</span>
                <span class="k">beq</span>     <span class="nv">down_right</span>
                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">6</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; down-left</span>
                <span class="k">beq</span>     <span class="nv">down_left</span>
                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">5</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; up-left</span>
                <span class="k">beq</span>     <span class="nv">up_left</span>
                <span class="k">bra</span>     <span class="nv">done</span>
<span class="nl">up</span>
                <span class="k">sub</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">y_coord</span>
                <span class="k">bra</span>     <span class="nv">done</span>
<span class="nl">down</span>    
                <span class="k">add</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">y_coord</span>
                <span class="k">bra</span>     <span class="nv">done</span>
<span class="nl">left</span>
                <span class="k">sub</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">x_coord</span>
                <span class="k">bra</span>     <span class="nv">done</span>
<span class="nl">right</span>
                <span class="k">add</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">x_coord</span>
                <span class="k">bra</span>     <span class="nv">done</span>
<span class="nl">up_right</span>
                <span class="k">sub</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">y_coord</span>
                <span class="k">add</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">x_coord</span>
                <span class="k">bra</span>     <span class="nv">done</span>
<span class="nl">down_right</span>
                <span class="k">add</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">y_coord</span>
                <span class="k">add</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">x_coord</span>
                <span class="k">bra</span>     <span class="nv">done</span>
<span class="nl">down_left</span>
                <span class="k">add</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">y_coord</span>
                <span class="k">sub</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">x_coord</span>
                <span class="k">bra</span>     <span class="nv">done</span>
<span class="nl">up_left</span>
                <span class="k">sub</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">y_coord</span>
                <span class="k">sub</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">x_coord</span>
                <span class="k">bra</span>     <span class="nv">done</span>
<span class="nl">done</span>

<span class="c1">; avoid going outside screen</span>
                <span class="k">cmp</span>     <span class="nd">#</span><span class="mi">319</span><span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="nv">x_coord</span>
                <span class="k">blt</span>     <span class="nv">x_right_ok</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">319</span><span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="nv">x_coord</span>
<span class="nl">x_right_ok</span>

                <span class="k">cmp</span>     <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="nv">x_coord</span> 
                <span class="k">bgt</span>     <span class="nv">x_left_ok</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="nv">x_coord</span>
<span class="nl">x_left_ok</span>

                <span class="k">cmp</span>     <span class="nd">#</span><span class="mi">199</span><span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="nv">y_coord</span>
                <span class="k">blt</span>     <span class="nv">y_low_ok</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">199</span><span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="nv">y_coord</span>
<span class="nl">y_low_ok</span>

                <span class="k">cmp</span>     <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="nv">y_coord</span>
                <span class="k">bgt</span>     <span class="nv">y_high_ok</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="nv">y_coord</span>
<span class="nl">y_high_ok</span>
                <span class="k">rts</span>


<span class="nl">read_joy</span>
<span class="c1">; executes every time joystick information is changed</span>
                <span class="k">move</span><span class="nd">.b </span> <span class="mi">1</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nv">joy</span>                <span class="c1">; store joy 0 data</span>
                <span class="k">move</span><span class="nd">.b </span> <span class="mi">2</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nv">joy</span><span class="o">+</span><span class="mi">1</span>              <span class="c1">; store joy 1 data</span>
                <span class="k">rts</span>

<span class="nl">apply_mask</span>
<span class="c1">; applies the mask to the background</span>
                <span class="k">jsr</span>     <span class="nv">get_coordinates</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">mask</span><span class="p">,</span> <span class="nb">a0</span>
                <span class="k">mulu</span>    <span class="nd">#</span><span class="mi">768</span><span class="p">,</span> <span class="nb">d0</span>                  <span class="c1">; multiply position with size</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nb">d0</span><span class="p">,</span> <span class="nb">a0</span>                    <span class="c1">; add value to mask pointer</span>
                
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d7</span>                 <span class="c1">; mask is 32 scan lines</span>
<span class="nl">maskloop</span>
                <span class="kr">rept</span>    <span class="mi">6</span>                         <span class="c1">; mask is 6*4 bytes width</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="nb">d0</span>                 <span class="c1">; mask data in d0</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a1</span><span class="p">),</span> <span class="nb">d1</span>                  <span class="c1">; background data in d1</span>
                <span class="k">and</span><span class="nd">.l </span>  <span class="nb">d0</span><span class="p">,</span> <span class="nb">d1</span>                    <span class="c1">; and mask and picture data</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nb">d1</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>                 <span class="c1">; move masked picture data to background</span>
                <span class="kr">endr</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">136</span><span class="p">,</span> <span class="nb">a1</span>                  <span class="c1">; next scan line</span>
                <span class="k">dbf</span>     <span class="nb">d7</span><span class="p">,</span> <span class="nv">maskloop</span>
                
                <span class="k">rts</span>

                
<span class="nl">put_sprite</span>
<span class="c1">; paints the sprite to the screen</span>
                <span class="k">jsr</span>     <span class="nv">get_coordinates</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">sprite</span><span class="p">,</span> <span class="nb">a0</span>
                <span class="k">mulu</span>    <span class="nd">#</span><span class="mi">768</span><span class="p">,</span> <span class="nb">d0</span>                  <span class="c1">; multiply position with size</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nb">d0</span><span class="p">,</span> <span class="nb">a0</span>                    <span class="c1">; add value to sprite pointer</span>
                    
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d7</span>                 <span class="c1">; sprite is 32 scan lines</span>
<span class="nl">bgloop</span>  
                <span class="kr">rept</span>    <span class="mi">6</span>                         <span class="c1">; sprite is 6*4 bytes width</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="nb">d0</span>                 <span class="c1">; sprite data in d0</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a1</span><span class="p">),</span> <span class="nb">d1</span>                  <span class="c1">; background data in d1</span>
                <span class="k">or</span><span class="nd">.l </span>   <span class="nb">d0</span><span class="p">,</span> <span class="nb">d1</span>                    <span class="c1">; or sprite and background data</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nb">d1</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>                 <span class="c1">; move ored sprite data to background</span>
                <span class="kr">endr</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">136</span><span class="p">,</span> <span class="nb">a1</span>
                <span class="k">dbf</span>     <span class="nb">d7</span><span class="p">,</span> <span class="nv">bgloop</span>  
                
                <span class="k">rts</span>
                

<span class="nl">save_background</span>
<span class="c1">; saves the background into bgsave</span>
                <span class="k">jsr</span>     <span class="nv">get_coordinates</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">bgsave</span><span class="p">,</span> <span class="nb">a0</span>

                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d7</span>                 <span class="c1">; sprite is 32 scan lines</span>
<span class="nl">bgsaveloop</span>
                <span class="kr">rept</span>    <span class="mi">6</span>                         <span class="c1">; sprite is 6*4 bytes width</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span>              <span class="c1">; copy background to save buffer</span>
                <span class="kr">endr</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">136</span><span class="p">,</span> <span class="nb">a1</span>                  <span class="c1">; next scan line</span>
                <span class="k">dbf</span>     <span class="nb">d7</span><span class="p">,</span> <span class="nv">bgsaveloop</span>
                
                <span class="k">rts</span>
                

<span class="nl">restore_background</span>
<span class="c1">; restores the background using data from bgsave</span>
                <span class="k">jsr</span>     <span class="nv">get_coordinates</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">bgsave</span><span class="p">,</span> <span class="nb">a0</span>

                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d7</span>                 <span class="c1">; sprite is 32 scan lines</span>
<span class="nl">bgrestoreloop</span>
                <span class="kr">rept</span>    <span class="mi">6</span>                         <span class="c1">; sprite is 6*4 bytes width</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>              <span class="c1">; copy save buffer to background</span>
                <span class="kr">endr</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">136</span><span class="p">,</span> <span class="nb">a1</span>                  <span class="c1">; next scan line</span>
                <span class="k">dbf</span>     <span class="nb">d7</span><span class="p">,</span> <span class="nv">bgrestoreloop</span>
                
                <span class="k">rts</span>

                
<span class="nl">get_coordinates</span>
<span class="c1">; makes a1 point to correct place on screen</span>
<span class="c1">; sprite position in d0.b</span>
                <span class="k">move</span><span class="nd">.l </span> <span class="mh">$44e</span><span class="p">,</span> <span class="nb">a1</span>                  <span class="c1">; screen memory in a1</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nv">y_coord</span><span class="p">,</span> <span class="nb">d0</span>               <span class="c1">; put y coordinate in d0</span>
                <span class="k">mulu</span>    <span class="nd">#</span><span class="mi">160</span><span class="p">,</span> <span class="nb">d0</span>                  <span class="c1">; 160 bytes to a scan line</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nb">d0</span><span class="p">,</span> <span class="nb">a1</span>                    <span class="c1">; add to screen pointer</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nv">x_coord</span><span class="p">,</span> <span class="nb">d0</span>               <span class="c1">; put x coordinate in d0</span>
                <span class="k">divu</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">16</span><span class="p">,</span> <span class="nb">d0</span>                   <span class="c1">; number of clusters in low, bit in high</span>
                <span class="k">clr</span><span class="nd">.l </span>  <span class="nb">d1</span>                        <span class="c1">; clear d1</span>
                <span class="k">move</span><span class="nd">.w </span> <span class="nb">d0</span><span class="p">,</span> <span class="nb">d1</span>                    <span class="c1">; move cluster part to d1</span>
                <span class="k">mulu</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">d1</span>                    <span class="c1">; 8 bytes to a cluster</span>
                <span class="k">add</span><span class="nd">.l </span>  <span class="nb">d1</span><span class="p">,</span> <span class="nb">a1</span>                    <span class="c1">; add cluster part to screen memory</span>
                <span class="k">clr</span><span class="nd">.w </span>  <span class="nb">d0</span>                        <span class="c1">; clear out the cluster value</span>
                <span class="k">swap</span>    <span class="nb">d0</span>                        <span class="c1">; bit to alter in low part of d0</span>

                <span class="k">rts</span>


                <span class="kr">include</span> <span class="nv">initlib</span><span class="nd">.s
</span>

                <span class="kr">section</span> <span class="nv">data</span>
<span class="nl">x_coord</span>         <span class="kt">dc</span><span class="nd">.w </span>   <span class="mi">150</span>
<span class="nl">y_coord</span>         <span class="kt">dc</span><span class="nd">.w </span>   <span class="mi">80</span>

<span class="nl">spr_dat</span>         <span class="kr">incbin</span>  <span class="nv">ship</span><span class="p">.</span><span class="nv">pi1</span>
<span class="nl">bg</span>              <span class="kr">incbin</span>  <span class="nv">xenon</span><span class="p">.</span><span class="nv">pi1</span>
<span class="nl">old_70</span>          <span class="kt">dc</span><span class="nd">.l </span>   <span class="mi">0</span>

<span class="nl">joy_on</span>          <span class="kt">dc</span><span class="nd">.b </span>   <span class="mh">$14</span>
<span class="nl">mus_on</span>          <span class="kt">dc</span><span class="nd">.b </span>   <span class="mh">$08</span>
<span class="nl">ikbd_vec</span>        <span class="kt">dc</span><span class="nd">.l </span>   <span class="mi">0</span>
<span class="nl">old_joy</span>         <span class="kt">dc</span><span class="nd">.l </span>   <span class="mi">0</span>


                <span class="kr">section</span> <span class="nv">bss</span>
<span class="nl">sprite</span>          <span class="kt">ds</span><span class="nd">.l </span>   <span class="mi">3072</span>                      <span class="c1">; 32/2+8*32 bytes * 16 positions / 4 for long</span>
<span class="nl">mask</span>            <span class="kt">ds</span><span class="nd">.l </span>   <span class="mi">3072</span>                      <span class="c1">; same as above</span>
<span class="nl">bgsave</span>          <span class="kt">ds</span><span class="nd">.l </span>   <span class="mi">192</span>                       <span class="c1">; 2/2+8*32 bytes / 4 for long</span>
<span class="nl">joy</span>             <span class="kt">ds</span><span class="nd">.b </span>   <span class="mi">2</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="img/tutorial-12-screenshot.png" alt="tutorial 12 screenshot">
</div>
<div class="title">Figure 20. Xenon 2</div>
</div>
<div class="paragraph">
<p>Yup, another long source code. There are big similarities between the sprite tutorial though,
since we&#8217;re basically doing the same thing. The new things are of course the joystick on and
off, which are located between the "; joy code" comments, after the pre-shiftings. Nothing to
say there that hasn&#8217;t been said before. Same with the joystick routine. The <code>move_sprite</code>
routine is all new and deserves attention.</p>
</div>
<div class="paragraph">
<p>It begins by moving the joystick data to <code>d0</code>. In this case, I only check joystick 1. First I begin
by checking for the fire button, this is done by seeing if <code>d0</code> contains a number larger than or
equal to 128. If the fire button is pressed, the 8th bit (bit 7, start counting from 0 and from
the rightmost bit) in the joystick status byte is set which means that the byte will hold a value
equal to or higher than 128, since <code>%10000000</code> = 128. Then I clear out the fire bit so that it
won&#8217;t bother me anymore.</p>
</div>
<div class="paragraph">
<p>Next I check for joystick movement. This is done by using the same method as above. For
example, if the joystick is down-left, then bit 1 and 2 are set, meaning the byte will hold
value <code>%00000110</code> = 6. This is the reason for clearing out the fire bit above. If it hadn&#8217;t been
cleared, the number would be either 6 or 128 + 6 = 134 for down-right. So just run through
all 8 directional checks to see if any bits are set, if they are not, I just branch right away to
done. If this branch hadn&#8217;t been there, the program would just continue and execute the
code associated with joystick up if the joystick wasn&#8217;t moved at all. An early bug that caused
me some confusion.</p>
</div>
<div class="paragraph">
<p>After the coordinates have been changed accordingly, I also check to see that the sprite isn&#8217;t
out of bounds, since this could cause a crash and be generally stupid in all kinds of ways. So
just check if the coordinates are right, and if they&#8217;re not, reset them to the closest correct
value. If you want a speedier ship, just increase the speed accordingly, adding more than one
to the coordinates, and also remember to include this in the boundary check, just as the
sprite.</p>
</div>
<div class="paragraph">
<p>Some of you will probably notice that the ship itself is not 32 scan lines, although I treat the
sprite as such. This has the effect of the ship never reaching all the way down the screen,
since there is some black space worth of sprite data. This could be easily fixed of course, but
I didn&#8217;t. Also, two ships moving might be nice, at first I considered having both the Xenon 2
ship and the Xenon 1 ship side by side, controlled by two joysticks, but I decided to keep it
simple. However, there should be no big trouble incorporating that, and changing the fire
button perhaps to morph the Xenon 1 ship.</p>
</div>
<div class="paragraph">
<p>Having two sprites is no harder than having one sprite, the only thing you have to think about
is the order of painting the sprites, the ones painted first will be painted over by the ones that
come next. Yet another cool thing is to change the look of the sprite as you move it, like in
the real Xenon game, they have the ship tilted sideways and generate rocket fire when it
moves, all you need is a flag to know which state the ship is in and change the sprite address
accordingly.</p>
</div>
<div class="paragraph">
<p>This means having a sprite picture with not just one ship, but the ship tilted in directions and
with rocket flames, all in all lots of pictures. All of these sprites will of course fit in one degas
picture, so all you need is the correct offset into this picture depending on what "mode" the
sprite is in. Compare this to the way we address the sprite mask, only in this case it&#8217;s a
different sprite (or different look of the sprite, depending on how you see it).</p>
</div>
<div class="paragraph">
<p>Now you have the tools needed to create a game, or even a demo for that matter: now go to
it! Even though there is still much to learn, the basics have been covered, all but one thing:
music and sound. It is my hope that this will come soon. But you don&#8217;t have to worry about
that for now, code away and the music will be easily incorporated at a later stage.</p>
</div>
<div class="paragraph">
<p>Usually, you just hook up the music in your VBL routine. On the Dead Hackers Society page,
<a href="http://dhs.nu/" class="bare">http://dhs.nu/</a>, there are two chip editors (at least) with instructions on how to play the
generated music in assembler: Edsynth and the XLR8. Go take a look at them if you&#8217;re
curious, there should be no trouble understanding the code.</p>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>← Previous: <a href="_of_making_the_mountain_move_to_mohammed.html">Of Making The Mountain Move To Mohammed</a> | ↑ Up: <a href="index.html">The Atari ST MC68000 Assembly Language Tutorials</a> | Next: <a href="_of_hearing_that_which_is_spoken.html">Of Hearing That Which Is Spoken</a> →</p>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1st edition (v0.84)<br>
Last updated 2022-04-23 15:26:12 UTC
</div>
</div>
</body>
</html>